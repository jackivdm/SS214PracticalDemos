<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Entry</title>

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      padding: 15px;
      max-width: 480px;
      margin: auto;
    }
    h2 { text-align: center; margin-bottom: 6px; }
    label { display: block; margin-top: 12px; font-weight: 600; }
    input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 14px;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: white;
    }
    button.secondary {
      background: #6c757d;
    }
    #reader { margin-top: 10px; }
    #status {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      white-space: pre-wrap;
    }
    .linkwrap {
      margin-top: 14px;
      text-align: center;
    }
    a {
      color: #007bff;
      text-decoration: underline;
      font-size: 15px;
    }
    .hint {
      font-size: 13px;
      color: #444;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<h2>Student Entry</h2>

<form id="entryForm">
  <label>Student Number</label>
  <input
  id="studentNumber"
  placeholder="Scan or type student number"
  required
  type="text"
  inputmode="numeric"
  pattern="[0-9]*"
>


  <button type="button" onclick="startScanner()">Scan Barcode</button>
  <div class="hint">Tip: If the camera doesn’t open, make sure you’re on HTTPS and have allowed camera access.</div>
  <div id="reader"></div>

  <label>Surname</label>
  <input id="surname" required autocomplete="off">

  <label>Demi</label>
  <input id="demi" required autocomplete="off">

  <button type="submit">Submit</button>
</form>

<div id="status">Ready</div>

<div class="linkwrap">
  <a href="#" onclick="newSubmission(); return false;">New submission</a>
</div>

<script>
/* =========================
   CONFIG
   ========================= */
const API_URL = "PASTE_YOUR_APPS_SCRIPT_URL_HERE";

/* =========================
   ELEMENTS
   ========================= */
const statusEl = document.getElementById("status");
const formEl = document.getElementById("entryForm");

const studentInput = document.getElementById("studentNumber");
const surnameInput = document.getElementById("surname");
const demiInput = document.getElementById("demi");

/* =========================
   PERSIST DEMI (optional but recommended)
   Keeps Demi across refreshes and new submissions.
   ========================= */
demiInput.value = localStorage.getItem("demi") || "";
demiInput.addEventListener("input", () => {
  localStorage.setItem("demi", demiInput.value);
});

/* =========================
   BARCODE SCANNING
   ========================= */
let scanner = null;

async function startScanner() {
  // Don’t start twice
  if (scanner) {
    statusEl.innerText = "Scanner already running…";
    return;
  }

  // Clear any previous reader content to avoid UI glitches
  document.getElementById("reader").innerHTML = "";

  try {
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      statusEl.innerText = "No camera found on this device.";
      return;
    }

    scanner = new Html5Qrcode("reader");

    statusEl.innerText = "Camera started. Point at the barcode…";

    await scanner.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 150 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      },
      async (decodedText) => {
        studentInput.value = decodedText.trim();
        statusEl.innerText = "Student number scanned ✔";

        // Stop camera after successful scan
        try { await scanner.stop(); } catch (_) {}
        scanner = null;

        // Move focus to surname for faster entry
        surnameInput.focus();
      },
      () => {
        // per-frame decode failures are normal; ignore
      }
    );

  } catch (err) {
    console.error(err);
    statusEl.innerText = "Camera start failed: " + (err?.message || err);
    scanner = null;
  }
}

function newSubmission() {
  // Stop scanner if running
  if (scanner) {
    scanner.stop().catch(() => {});
    scanner = null;
  }

  // Clear ONLY per-student fields
  studentInput.value = "";
  surnameInput.value = "";

  // Keep Demi populated (do NOT clear demiInput.value)

  statusEl.innerText = "Ready";
  studentInput.focus();
}

/* =========================
   SUBMIT
   ========================= */
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Let browser show required-field messages if missing
  if (!formEl.checkValidity()) {
    formEl.reportValidity();
    return;
  }

  const payload = {
    studentNumber: studentInput.value.trim(),
    surname: surnameInput.value.trim(),
    demi: demiInput.value.trim()
  };

  if (!payload.studentNumber || !payload.surname || !payload.demi) {
    statusEl.innerText = "Please complete all fields.";
    return;
  }

  statusEl.innerText = "Saving…";

  try {
    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    statusEl.innerText = "Saved ✔";

    // Prepare next entry (keeps Demi)
    newSubmission();

  } catch (err) {
    console.error(err);
    statusEl.innerText = "Save failed. Check network / API URL.";
  }
});
</script>

</body>
</html>
